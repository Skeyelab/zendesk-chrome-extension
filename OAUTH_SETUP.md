# Zendesk OAuth Setup Guide

This guide walks you through the one-time setup required to enable OAuth authentication between the Chrome extension and your Zendesk instance.

## Overview

The Chrome extension uses OAuth 2.0 to securely authenticate with Zendesk. This requires:

1. **Zendesk OAuth Client** - A confidential OAuth client registered in your Zendesk Admin Center
2. **Chrome Extension ID** - The unique identifier of your installed extension
3. **Redirect URI** - The OAuth callback URL for the Chrome extension
4. **Proxy Server Configuration** - Environment variables with client credentials

## Prerequisites

- Admin access to your Zendesk account
- Chrome extension installed (unpacked for development or published for production)
- Access to the proxy server environment variables (e.g., Coolify, Docker, etc.)

---

## Step 1: Register OAuth Client in Zendesk

### 1.1 Navigate to OAuth Clients

1. Log in to your Zendesk Admin Center
2. Go to **Apps and integrations** → **APIs** → **OAuth Clients**
3. Click **Add OAuth client** button

### 1.2 Configure OAuth Client

Fill in the OAuth client form with the following settings:

| Field | Value | Notes |
|-------|-------|-------|
| **Client name** | `Zendesk Chrome Extension` | Choose a descriptive name |
| **Description** | `OAuth client for Zendesk Sidebar Chrome Extension` | Optional but recommended |
| **Company** | Your company name | Optional |
| **Client kind** | **Confidential** | ⚠️ **Required** - Must be "Confidential" |
| **Redirect URLs** | `https://<EXTENSION_ID>.chromiumapp.org/` | See Step 2 for extension ID |

⚠️ **Important Notes:**
- **Client kind MUST be "Confidential"** - This is required for server-side token exchange
- Do NOT use "Public" client type
- The redirect URL format is critical - see Step 2 for details

### 1.3 Save Client Credentials

After creating the client:

1. **Copy the Client ID** - Save this securely (you'll need it for the proxy)
2. **Copy the Client Secret** - Save this securely (shown only once!)
3. **NEVER commit these credentials to git** - Store them only in your proxy's environment variables

Example credentials format:
```
Client ID: zendesk_chrome_extension_abc123xyz
Client Secret: a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6q7r8s9t0
```

⚠️ **Security Warning:**
- Client credentials should NEVER be stored in the Chrome extension code
- Only store credentials in the proxy server's environment variables
- Never commit `.env` files containing real credentials

---

## Step 2: Get Chrome Extension ID

The Chrome extension ID is a unique identifier automatically generated by Chrome. You need this ID to configure the OAuth redirect URI.

### 2.1 For Unpacked Extension (Development)

If you're testing with an unpacked extension:

1. Open Chrome and navigate to `chrome://extensions/`
2. Ensure **Developer mode** is enabled (toggle in top right)
3. Find your extension in the list: **"Zendesk Sidebar Extension"**
4. Look for the **ID** field under the extension name
5. Copy the ID (format: `abcdefghijklmnopqrstuvwxyz123456`)

**Example:**
```
ID: lmnoabcdefghijklpqrstuvwxyz1234
```

### 2.2 For Published Extension (Production)

If you've published your extension to the Chrome Web Store:

1. Go to the [Chrome Web Store Developer Dashboard](https://chrome.google.com/webstore/devconsole)
2. Find your extension in the list
3. The extension ID is shown in the item details
4. Copy the ID

**Alternative method using chrome.identity API:**

Create a temporary HTML file in your extension directory:

**get-extension-id.html:**
```html
<!DOCTYPE html>
<html>
<head>
  <title>Get Extension ID</title>
</head>
<body>
  <h1>Extension ID Finder</h1>
  <p>Extension ID: <strong id="extension-id">Loading...</strong></p>
  <p>Redirect URI: <strong id="redirect-uri">Loading...</strong></p>
  <script>
    // Get the extension ID
    const extensionId = chrome.runtime.id;
    document.getElementById('extension-id').textContent = extensionId;
    
    // Get the redirect URI
    const redirectUri = chrome.identity.getRedirectURL();
    document.getElementById('redirect-uri').textContent = redirectUri;
    
    console.log('Extension ID:', extensionId);
    console.log('Redirect URI:', redirectUri);
  </script>
</body>
</html>
```

Then:
1. Load the extension in Chrome
2. Open `get-extension-id.html` as an extension page
3. The page will display both the extension ID and the full redirect URI

### 2.3 Understanding Extension IDs

**Important facts about extension IDs:**

- Extension IDs are **different** between unpacked and published versions
- Each unpacked extension gets a unique ID based on its installation path
- Published extensions get a permanent ID from the Chrome Web Store
- If you delete and reload an unpacked extension, the ID may change
- To keep a consistent ID for unpacked extensions, don't delete/re-add it

---

## Step 3: Configure Redirect URI

### 3.1 Format the Redirect URI

Using the extension ID from Step 2, construct the redirect URI:

**Format:**
```
https://<EXTENSION_ID>.chromiumapp.org/
```

**Example:**
```
https://lmnoabcdefghijklpqrstuvwxyz1234.chromiumapp.org/
```

⚠️ **Critical Details:**
- Must use `https://` scheme
- Must include the extension ID
- Must use `.chromiumapp.org` domain
- Must include trailing slash `/`
- This is a Chrome-provided special domain for extensions

### 3.2 Add Redirect URI to Zendesk OAuth Client

1. Return to your Zendesk OAuth client (Admin Center → APIs → OAuth Clients)
2. Click on your OAuth client to edit it
3. Find the **Redirect URLs** field
4. Add the redirect URI: `https://<EXTENSION_ID>.chromiumapp.org/`
5. Click **Save**

**Multiple environments:**

If you have multiple extension instances (dev, staging, production), add all redirect URIs:

```
https://dev-extension-id-abc123.chromiumapp.org/
https://staging-extension-id-def456.chromiumapp.org/
https://prod-extension-id-ghi789.chromiumapp.org/
```

---

## Step 4: Configure Proxy Server

### 4.1 Set Environment Variables

Configure your proxy server with the OAuth credentials from Step 1.

**Required environment variables:**

```bash
# Zendesk OAuth Configuration
ZENDESK_CLIENT_ID=your_client_id_from_step_1
ZENDESK_CLIENT_SECRET=your_client_secret_from_step_1

# Session Configuration
SESSION_SECRET=generate_a_secure_random_string

# CORS Configuration
ALLOWED_ORIGINS=chrome-extension://your-extension-id

# Optional: Default subdomain
ZENDESK_SUBDOMAIN=your-zendesk-subdomain
```

### 4.2 Generate Session Secret

Generate a secure random session secret:

**Using OpenSSL:**
```bash
openssl rand -hex 32
```

**Using Node.js:**
```bash
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
```

**Using Python:**
```bash
python3 -c "import secrets; print(secrets.token_hex(32))"
```

Copy the output and use it as your `SESSION_SECRET`.

### 4.3 Configure CORS Origins

The `ALLOWED_ORIGINS` environment variable should include your extension's origin:

**Format:**
```bash
ALLOWED_ORIGINS=chrome-extension://<EXTENSION_ID>
```

**Example:**
```bash
ALLOWED_ORIGINS=chrome-extension://lmnoabcdefghijklpqrstuvwxyz1234
```

**Multiple extensions (comma-separated):**
```bash
ALLOWED_ORIGINS=chrome-extension://dev-id,chrome-extension://prod-id
```

### 4.4 Deployment-Specific Instructions

#### For Coolify:

1. Log in to your Coolify dashboard
2. Navigate to your proxy application
3. Go to **Environment Variables** tab
4. Add each variable listed above
5. Click **Save** and restart the application

#### For Docker:

Create a `.env` file (never commit this!):

```bash
# .env
ZENDESK_CLIENT_ID=your_client_id
ZENDESK_CLIENT_SECRET=your_client_secret
SESSION_SECRET=your_generated_secret
ALLOWED_ORIGINS=chrome-extension://your-extension-id
NODE_ENV=production
```

Run with:
```bash
docker run -p 3000:3000 --env-file .env zendesk-proxy:latest
```

#### For Heroku/Other Platforms:

Use the platform's environment variable configuration interface to set all required variables.

---

## Step 5: Verification Checklist

Use this checklist to verify your setup is complete:

### Zendesk OAuth Client
- [ ] OAuth client created in Zendesk Admin Center
- [ ] Client kind set to **Confidential**
- [ ] Client ID and Secret saved securely
- [ ] Redirect URI added: `https://<EXTENSION_ID>.chromiumapp.org/`

### Chrome Extension
- [ ] Extension installed in Chrome
- [ ] Extension ID obtained
- [ ] Extension ID format verified (32 characters)

### Proxy Server
- [ ] `ZENDESK_CLIENT_ID` environment variable set
- [ ] `ZENDESK_CLIENT_SECRET` environment variable set
- [ ] `SESSION_SECRET` environment variable set (secure random string)
- [ ] `ALLOWED_ORIGINS` environment variable set with extension ID
- [ ] Proxy server running and accessible
- [ ] Health check endpoint responding: `GET /health` returns `{"status":"ok"}`

### Security
- [ ] No credentials committed to git
- [ ] `.env` file in `.gitignore`
- [ ] Client Secret stored securely (not in extension code)
- [ ] HTTPS enabled for proxy in production

---

## Troubleshooting

### Issue: "Redirect URI mismatch" error

**Cause:** The redirect URI in the OAuth request doesn't match what's configured in Zendesk.

**Solution:**
1. Verify the extension ID is correct
2. Ensure the redirect URI format is exact: `https://<ID>.chromiumapp.org/`
3. Check for trailing slash in Zendesk configuration
4. Verify you're using the correct extension ID (unpacked vs published)

### Issue: "Invalid client" error

**Cause:** Client ID or Secret is incorrect.

**Solution:**
1. Verify `ZENDESK_CLIENT_ID` matches the client ID in Zendesk
2. Verify `ZENDESK_CLIENT_SECRET` is correct (check for copy/paste errors)
3. Ensure client kind is "Confidential" in Zendesk

### Issue: CORS error when calling proxy

**Cause:** Extension origin not in `ALLOWED_ORIGINS`.

**Solution:**
1. Get actual extension ID from `chrome://extensions/`
2. Update `ALLOWED_ORIGINS` to include: `chrome-extension://<ACTUAL_ID>`
3. Restart proxy server
4. Check browser console for actual origin being sent

### Issue: Extension ID changed after reloading unpacked extension

**Cause:** Chrome generates new IDs when unpacked extensions are removed and re-added.

**Solution:**
1. Don't delete the extension, just click "Reload" button instead
2. For consistent IDs, use a published extension or create a packed extension
3. Update redirect URI in Zendesk if ID changed
4. Update `ALLOWED_ORIGINS` in proxy if ID changed

---

## Security Best Practices

1. **Never expose credentials:**
   - Don't commit client secrets to git
   - Don't include secrets in extension code
   - Use environment variables for all secrets

2. **Limit OAuth scopes:**
   - Only request Zendesk scopes you actually need
   - Follow principle of least privilege

3. **Secure token storage:**
   - Extension stores only session tokens (never raw access tokens)
   - Proxy handles all token exchange and refresh
   - Use in-memory session store for single-instance deployments
   - Consider Redis for multi-instance deployments

4. **CORS restrictions:**
   - Only allow your specific extension IDs in `ALLOWED_ORIGINS`
   - Never use `*` wildcard in production

5. **HTTPS everywhere:**
   - Always use HTTPS for proxy server in production
   - Chrome extension uses `https://` scheme for redirect URIs

---

## Additional Resources

- [Zendesk OAuth Documentation](https://developer.zendesk.com/documentation/api-basics/getting-started/oauth/)
- [Chrome Identity API Documentation](https://developer.chrome.com/docs/extensions/reference/identity/)
- [Chrome Extension OAuth Guide](https://developer.chrome.com/docs/extensions/mv3/tut_oauth/)
- [OAuth 2.0 RFC](https://tools.ietf.org/html/rfc6749)

---

## Getting Help

If you encounter issues not covered in this guide:

1. Check the proxy server logs for detailed error messages
2. Check Chrome DevTools console for extension errors
3. Verify all environment variables are set correctly
4. Review the [proxy README](/proxy/README.md) for deployment details
5. Open an issue in the GitHub repository

---

**Last Updated:** 2026-02-17  
**Version:** 1.0
